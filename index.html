<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            margin: 20px auto;
            height: 60vh;
            width: 90vw;
            max-width: 1000px;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        #loading, #error {
            text-align: center;
            display: none;
        }
        #error { color: red; }
        #lastUpdated {
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }
        
        .header-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 120px;
            height: 100px;
            margin: 0 auto 10px;
            border-radius: 50%;
        }
        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        @media (max-width: 600px) {
            .chart-container {
                height: 50vh;
                width: 95vw;
            }
            .logo {
                width: 80px;
                height: 80px;
            }
            .company-name {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="logo">
            <img src="./logo.jpg" alt="Spartan Crypto Investments Logo" style="width:100%;height:100%;border-radius:50%;">
        </div>
        <div class="company-name">Spartan Crypto Investments</div>
    </div>
   
    <div id="loading">Loading data...</div>
    <div id="error"></div>
    <div id="lastUpdated"></div>
    <div class="chart-container">
        <canvas id="financialChart"></canvas>
    </div>

    <script>
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const lastUpdatedDiv = document.getElementById('lastUpdated');
        let chart = null;

        function updateChart() {
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            const url = `./data.json?nocache=${new Date().getTime()}`;
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingDiv.style.display = 'none';
                    
                    // Process data
                    const year = data[0].date.split('-')[0];
                    const dates = data.map(item => {
                        const [_, month, day] = item.date.split('-');
                        return `${month}-${day}`;
                    });
                    const amounts = data.map(item => Number(item.amount.toFixed(2)));
                    const yields = data.map(item => Number(item.yield.toFixed(2)));
                    const yieldPercentages = data.map(item => 
                        item.amount !== 0 ? (item.yield / item.amount * 100).toFixed(2) : "0.00"
                    );
                    
                    // Calculate total yield earned
                    const totalYields = [];
                    let cumulativeYield = 0;
                    data.forEach(item => {
                        cumulativeYield += item.yield;
                        totalYields.push(Number(cumulativeYield.toFixed(2)));
                    });

                    if (!chart) {
                        // Create chart
                        const ctx = document.getElementById('financialChart').getContext('2d');
                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [
                                    {
                                        label: 'Amount ($)',
                                        data: amounts,
                                        borderColor: 'rgb(75, 192, 192)',
                                        tension: 0.1,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'Daily Yield ($)',
                                        data: yields,
                                        borderColor: 'rgb(255, 99, 132)',
                                        tension: 0.1,
                                        yAxisID: 'y1'
                                    },
                                    {
                                        label: 'Total Yield Earned ($)',
                                        data: totalYields,
                                        borderColor: 'rgb(54, 162, 235)',
                                        tension: 0.1,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `Financial Data - ${year}`,
                                        font: { size: 20 }
                                    },
                                    legend: { position: 'top' },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': $' + context.parsed.y.toFixed(2);
                                                }
                                                return label;
                                            },
                                            afterLabel: function(context) {
                                                if (context.dataset.label === 'Daily Yield ($)') {
                                                    const index = context.dataIndex;
                                                    return `Yield %: ${yieldPercentages[index]}%`;
                                                }
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        title: { display: true, text: 'Month-Day' } 
                                    },
                                    y: { 
                                        type: 'linear',
                                        position: 'left',
                                        title: { display: true, text: 'Amount ($)' },
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toFixed(2);
                                            }
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        position: 'right',
                                        title: { display: true, text: 'Yield ($)' },
                                        beginAtZero: true,
                                        grid: { drawOnChartArea: false },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toFixed(2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        // Update existing chart
                        chart.data.labels = dates;
                        chart.data.datasets[0].data = amounts;
                        chart.data.datasets[1].data = yields;
                        chart.data.datasets[2].data = totalYields;
                        chart.options.plugins.title.text = `Financial Data - ${year}`;
                        chart.update();
                    }

                    lastUpdatedDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()} - Data points: ${data.length}`;
                    console.log('Data loaded:', data);
                    console.log('Yield Percentages:', yieldPercentages);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = `Error loading data: ${error.message}<br>
                        Check server, file path, and JSON validity`;
                    console.error('Fetch error:', error);
                });
        }

        // Initial load
        updateChart();
        setInterval(updateChart, 10000);
    </script>
</body>
</html>